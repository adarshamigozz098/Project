<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>SHOEzzo</title>
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="" />
  <meta property="og:type" content="" />
  <meta property="og:url" content="" />
  <meta property="og:image" content="" />
  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="imgs/theme/favicon.svg" />
  <!-- Template CSS -->
  <link href="css/main.css?v=1.1" rel="stylesheet" type="text/css" />
</head>

<body>
  <style></style>
  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
      <a class="navbar-brand" href="/">SHOEzzo</a>
      <div>
        <button class="btn btn-icon btn-aside-minimize">
          <i class="text-muted material-icons md-menu_open"></i>
        </button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside ">
        <li class="menu-item active">
          <a class="menu-link" href="/admin/dashboard">
            <i class="icon material-icons md-home"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/users">
            <i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Users</span>
          </a>
        </li>

        <li class="menu-item ">
          <a class="menu-link" href="/admin/category">
            <i class="icon material-icons md-shopping_cart"></i>
            <span class="text">Catgeory</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/products">
            <i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Products</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/order">
            <i class="icon material-icons md-shopping_cart"></i>
            <span class="text">orders</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/coupon">
            <i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Coupons</span>
          </a>
        </li>
      </ul>
      <br />
      <br />
    </nav>
  </aside>
  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search">
        <!-- <form class="searchform">
          <div class="input-group">
            <input list="search_terms" type="text" class="form-control" placeholder="Search term" />
            <button class="btn btn-light bg" type="button">
              <i class="material-icons md-search"></i>
            </button>
          </div>
          <datalist id="search_terms">
            <option value=""></option>
            <option value=""></option>
            <option value=""></option>
            <option value=""></option>
          </datalist>
        </form> -->
      </div>
      <div class="col-nav">
        <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside">
          <i class="material-icons md-apps"></i>
        </button>
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link btn-icon" href="#">
              <i class="material-icons md-notifications animation-shake"></i>
              <span class="badge rounded-pill">3</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link btn-icon darkmode" href="#">
              <i class="material-icons md-nights_stay"></i>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="requestfullscreen nav-link btn-icon"><i class="material-icons md-cast"></i></a>
          </li>
          <li class="dropdown nav-item">
            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownLanguage" aria-expanded="false"><i
                class="material-icons md-public"></i></a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownLanguage">
              <a class="dropdown-item text-brand" href="#"><img src="imgs/theme/flag-us.png" alt="English" />English</a>
            </div>
          </li>
          <li class="dropdown nav-item">
            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false">
              <img class="img-xs rounded-circle" src="imgs/people/avatar-2.png" alt="User" /></a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">


              <div class="dropdown-divider"></div>
              <a class="dropdown-item text-danger" href="/admin/logout">
                <i class="material-icons md-exit_to_app"></i>Logout
              </a>
            </div>
          </li>
        </ul>
      </div>
    </header>

    <div class="main-panel">
      <div class="content-wrapper">
        <div class="col-lg-12 stretch-card">
          <div class="card">
            <div class="card-body">
              <!-- download -->

              <div class="bttn" style="float: inline-end">
                <div class="dropdown btn-group mt-3">
                  <button href="#" class="btn btn-primary rounded font-md btn-sm mr-2"
                    onclick="generateExcel()">Excel</button>
                  <button class="btn btn-primary dropdown-toggle btn-sm" type="button" id="dropdownMenuButton1"
                    onclick="downloadPDF('printThisDiv')" data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false"> <b style="text-decoration: darkgreen;">PDF DOWNLOAD</b>
                  </button>
                </div>
              </div>



              <!-- heading -->
              <h2
                style="margin-left: 39%;font-family:'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;">
                <b
                  style="font-weight: 300; color: rgb(203, 177, 177);  margin-left: -420px; ;  background-color: rgb(244 244 244);;">SALES
                  REPORT</b>
              </h2>

              <!-- date -->
              <div class="row mt-4">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label><b style="color: rgb(0, 0, 0);">Select Start Date:</b></label>
                    <input type="date" id="fromDateInput" class="form-control">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label><b style="color: rgb(0, 0, 0);"> Select End Date</b>:</label>
                    <input type="date" id="toDateInput" class="form-control">
                  </div>
                </div>
              </div>



              <!-- table -->
              <div class="table-responsive">
                <div id="printThisDiv">
                  <% if(salesReport && salesReport.length> 0 ){ %>
                    <table class="table table-bordered table-contextual" id="example">
                      <thead id="reportHeader">
                        <tr>
                          <th>Product Name</th>
                          <th>Email</th>
                          <th>OrderId</th>
                          <th>Date</th>
                          <th>PM</th>
                          <th>Total</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="reportBody">
                        <% salesReport.forEach(order=> { %>
                          <% order.items.forEach(item=> { %>
                            <% if (item.ordered_status==="Delivered" ) { %>
                              <tr>
                                <td>
                                  <%= item.product_id.name %>
                                </td>
                                <td>
                                  <%= order.user_id.email %>
                                </td>
                                <td>
                                  <%= order.order_id %>
                                </td>
                                <td>
                                  <%= moment(order.date).format('DD/MM/YYYY') %>
                                </td>
                                <td>
                                  <%= order.payment %>
                                </td>
                                <td>
                                  <%= (item.price * item.quantity) - item.discountPerItem %>
                                </td>
                                <td>
                                  <%= item.ordered_status %>
                                </td>

                                <!-- <td><%= item.quantity %></td> -->
                              </tr>
                              <% } %>
                                <% }) %>
                                  <% }) %>
                      </tbody>
                    </table>
                    <% }else{ %>
                      <p class="text-center">No Sales</p>
                      <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style>
      .form-control,
      .form-select {
        background-color: #f6f6f6;
        border: 3px solid #e9e9e9;
        font-size: 14px;
        -webkit-box-shadow: none;
        box-shadow: none;
        padding-left: 20px;
        color: #4f5d77;
        width: 105%;
        border-radius: 4px;
        height: 52px;
      }

      element.style {
        font-weight: 300;
        color: rgb(203, 177, 177);
        margin-left: -4px;
        background-color: rgb(244 244 244);
      }
    </style>

    <style>
      b {
        font-weight: 1100;

        .col-lg-6 {
          -webkit-box-flex: 0;
          -ms-flex: 0 0 auto;
          flex: 0 0 auto;
          width: 12%;
        }
      }
    </style>
</body>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>document.addEventListener('DOMContentLoaded', function () {
    const fromDateInput = document.querySelector('#fromDateInput');
    const toDateInput = document.querySelector('#toDateInput');

    console.log(fromDateInput, toDateInput);


    const fetchData = async () => {
      try {
        const response = await axios.get('/admin/datePicker', {
          params: {
            startDate: fromDateInput.value,
            endDate: toDateInput.value
          },
        });
        console.log('startDate:', fromDateInput.value, 'endDate:', toDateInput.value);

        const salesReport = response.data.selectedDate

        const reportBody = document.getElementById("reportBody")
        reportBody.innerHTML = salesReport
          .map((order) => {
            return order.items
              .filter((item) => item.ordered_status === "Delivered")
              .map((item) => `
<tr>
  <td>${item.product.name}</td>
     <td>${order.user[0].email}</td>
     <td>${order.order_id}</td>
     <td>${moment(order.date).format('DD/MM/YYYY')}</td>
     <td>${order.payment}</td>
     <td>${(item.price * item.quantity) - item.discountPerItem}</td>
     <td>${item.ordered_status}</td>
  

 </tr>`)
              .join("")
          })
          .join("")
        const tableHeader = `
<tr>
  <th>Product Name</th>
<th>Email</th>
<th>OrderId</th>
<th>Date</th>
<th>Payment Method</th>
<th>Total</th>
<th>Status</th>
</tr>`

        const reportHeader = document.getElementById("reportHeader")
        reportHeader.innerHTML = tableHeader

      } catch (error) {
        console.error('Error fetching sales data:', error);
      }
    };
    fromDateInput.addEventListener('change', fetchData);
    toDateInput.addEventListener('change', fetchData);

  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>

<script>
  function showDownloadOptions(divName) {
    const choise = confirm("Do you want to download as PDF and Excel?")

    if (choise) {
      downloadPDF(divName)
    } else {
      downloadExcel(divName)
    }
  }

  function downloadPDF(divName) {
    const printContents = document.getElementById(divName).innerHTML;
    const orginalContents = document.body.innerHTML;
    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = orginalContents;
  }

  function downloadExcel(divName) {
    const table = document.getElementById(divName);
    const rows = table.getElementsByTagName('tr');

    let csvContent = "\uFEFF";

    const headerCells = table.querySelectorAll('thead th');
    const headerValues = Array.from(headerCells).map(header => header.textContent.trim());
    csvContent += headerValues.join(',') + '\n';


    for (let i = 1; i < rows.length; i++) {
      const cells = rows[i].getElementsByTagName('td');
      const cellValues = Array.from(cells).map(cell => cell.textContent.trim());
      csvContent += cellValues.join(',') + '\n';
    }

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.setAttribute('download', 'data.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // excel
  async function generateExcel() {
    try {
      let totalOrders;
      const startDate = new Date(req.body.fromDate);
      const endDate = new Date(req.body.toDate);
      console.log(startDate, endDate);
      totalOrders = await order.aggregate([
        {
          $match: {
            orderDate: {
              $gte: startDate,
              $lte: endDate,
            },
          },
        },
        { $unwind: "$products" },
        {
          $group: {
            _id: "$_id",
            count: { $sum: 1 },
            products: { $push: "$products" },
          },
        },
        { $project: { count: 1, products: 1 } },
      ]);

      const totalUsers = await User.countDocuments();
      console.log(totalUsers, "us");
      const totalSales = await order.aggregate([
        {
          $match: {
            orderDate: {
              $gte: startDate,
              $lte: endDate,
            },
          },
        },
        { $unwind: "$products" },
        {
          $group: {
            _id: null,
            sum: { $sum: "$products.price" },
          },
        },
      ]);

      const csvFields = ["Order ID", "Product Name", "Product Price"];
      const csvHeader = csvFields.join(",") + "\n";
      let csvValues = "";

      totalOrders.forEach((order) => {
        order.products.forEach((product) => {
          csvValues += `${order._id},"${product.pname}",${product.price}\n`;
        });
      });

      const totalOrdersCount = totalOrders.reduce(
        (acc, order) => acc + order.count,
        0
      );

      csvValues += `${totalOrdersCount},${totalUsers},${totalSales[0]?.sum || 0
        }\n`;

      const csvData = csvHeader + csvValues;

      res.setHeader("Content-Type", "text/csv");
      res.setHeader(
        "Content-Disposition",
        "attachment;filename=salesReport.csv"
      );
      res.status(200).send(csvData);
    } catch (err) {
      console.log(err);
      res.status(500).send("Internal server error");
    }
  }

  function s2ab(s) {
    const buf = new ArrayBuffer(s.length);
    const view = new Uint8Array(buf);
    for (let i = 0; i !== s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
    return buf;
  }
</script>